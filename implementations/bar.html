<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>CS360/560 Midterm: Datalization</title>

        <!-- Required CSS files -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/owl.carousel.css">
    <link rel="stylesheet" href="../assets/css/barfiller.css">
    <link rel="stylesheet" href="../assets/css/animate.css">
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/css/slicknav.css">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="https://www.jq22.com/jquery/font-awesome.4.7.0.css">
    <script src="https://d3js.org/d3.v5.min.js"></script>
	<style>
		.chart-container {
			font-size: 24px;
			font-weight: 300;
		}
		.legend-label {
			font-size: 12px;
		}
		.legend-title {
			font-size: 12px;
			font-weight: 400;
			fill: #000;
		}
		.label {
  			font-family: "Roboto", sans-serif;
			font-size: 15px;
			font-weight: 300;
		}
		.block {
			cursor: pointer;
		}
		.toolTip {
			position: absolute;
			display: none;
			min-width: 200px;
			white-space: nowrap;
			height: auto;
			background-color: #ffffff;
			border: 1px solid #2d3666;
			border-radius: 2px;
			padding: 5px 10px;
			font-size: 12px;
			margin-top: -10px;
			transform: translate(-50%, -100%);
			/* Backward compatibility */
			-webkit-transform: translate(-50%, -100%);
			-moz-transform: translate(-50%, -100%);
			-o-transform: translate(-50%, -100%);
			-ms-transform: translate(-50%, -100%);
		}
	</style>
</head>

<body>
    <div class="preloader">
        <span class="preloader-spin"></span>
    </div>
    <div class="site">
		<header id="header">
			<div class="container">
				<div class="row">
					<div class="col-6 col-sm-3 logo-column">
						<h3><a href="/midterm-datalization/" class="logo">Datalization</a></h3>
					</div>
					<div class="col-6 col-sm-9 nav-column clearfix">
						<nav id="menu" class="d-none d-lg-block">
							<ul>
								<li><a href="/midterm-datalization/">Home</a></li>
								<li><a href="/midterm-datalization/dataset.html">Dataset</a></li>
								<li class="has-child">
									<a href="#">Prototypes</a>
									<ul class="sub-menu">
										<li><a href="/midterm-datalization/prototypes/bar-chart.html"><i class="fa fa-bar-chart"></i> Sum of Number of Records for each Neighborhoods 2010-2019</a></li>
										<li><a href="/midterm-datalization/prototypes/line-chart.html"><i class="fa fa-line-chart"></i> The Averge Response Time and Arrive Time For Emergencies 2010-2019</a></li>
										<li><a href="/midterm-datalization/prototypes/area-chart.html"><i class="fa fa-area-chart"></i> Count of Various Emergencies by Year: 2010-2019</a></li>
									</ul>
								</li>
								<li class="has-child">
									<a href="#">Implementations</a>
									<ul class="sub-menu">
										<li><a href="/midterm-datalization/implementations/bar.html"><i class="fa fa-bar-chart"></i> Sum of Number of Records for each Neighborhoods 2010-2019</a></li>
										<li><a href="/midterm-datalization/implementations/line-chart-d3.html"><i class="fa fa-line-chart"></i> The Averge Response Time and Arrive Time For Emergencies 2010-2019</a></li>
										<li><a href="/midterm-datalization/implementations/area-chart.html"><i class="fa fa-area-chart"></i> Count of Various Emergencies by Year: 2010-2019</a></li>
									</ul>
								</li>
								<li><a href="/midterm-datalization/team.html">Team</a></li>
							</ul>
						</nav>
					</div>
				</div>
			</div>
		</header>
		<main id="main">
			<div class="page-title sp" style="background-image: url(../assets/img/home-banner.jpg)">
				<div class="container text-center">
					<h2>D3 Implementation</h2>
					<p>Sum of Number of Emergencies for each Neighborhoods</p>
				</div>
			</div>
			<div class="about-area sp">
				<div class="container content-main">
					<h2>Sum of Number of Emergencies for each Neighborhoods</h2>
					<hr class="divider"\>
					<h3>Data encoding</h3>
					<p>In my bar chart implementation, the x-axis represents the sum of a number of emergencies, and the y-axis represents all major neighborhoods in San Francisco, while the color represents a different call type group.</p>
					<p>So, the longer the bar is, the larger the amount of emergencies that have been recorded from that neighborhood.</p>
					<h3 class="top-space">Guide of Interactivities</h3>
					<p>Overall, this implementation has 4 major types of interactivities, including zooming, mouse enter and out, clicking and dragging.</p>
					<h4>Zooming</h4>
					<p>TThis implementation allows the user to zoom in to make the detail more readable.</p>
					<p>There are two ways to zoom in the chart:</p>
					<ol>
						<li>Move the mouse cursor to white space of the chart's canvas, and double-click, it zooms in the chart by double of its size.</li>
						<li>Move the mouse cursor to the chart's canvas, scroll up.</li>
					</ol>
					<p>To zoom out, simply scroll down the mouse.</p>
					<img src="../assets/img/bar-interactivities/interactivity1.gif">
					<h4 class="top-space">Hovering</h4>
					<p>Hovering/mouse entering a color block will highlight the current color block(call type) in this neighborhood and fade out other color blocks(call types) from the same neighborhood.</p>
					<p>Besides, it will display a tooltip, which covers the neighborhood name, the call type, the number of emergencies and the ratio of number among the current neighborhood.</p>
					<p>Move the mouse out of the color block(call type) will cancel the highlight and make the tooltip disappear.</p>
					<img src="../assets/img/bar-interactivities/interactivity2.gif">
					<h4 class="top-space">Clicking</h4>
					<p>This interactivity is very similar to the hover, but it listens to the mouse clicking. Clicking on a color block(call type) will highlight the current color blocks(call types) in all neighborhoods and fade out other color blocks(call types) from all the neighborhoods.</p>
					<p>Also, it will display a tooltip, but it's a little different than the hovering one, because it covers the first 3 same information, but the last information is the ratio of number among the same call type from all neighborhoods.</p>
					<p>Move the mouse out of the current block(call type) will cancel the highlight and make the tooltip disappear.</p>
					<img src="../assets/img/bar-interactivities/interactivity3.gif">
					<h4 class="top-space">Dragging</h4>
					<p>The chart also allows readers to drag the bars up and down, the reason to do this is that they will be able to align the bar with the x-axis and use the axis as a ruler to determine the actual data of the bar.</p>
					<p>To drag the chart, simply keep pressing the mouse on the white space of the chart's canvas and move the mouse up or down. Remember, don't click on the bars, otherwise, it will highlight the bar instead.</p>
					<img src="../assets/img/bar-interactivities/interactivity4.gif">
					<hr class="divider"\>
					<h3 class="top-space">Implementation</h3>
					<div class="chart-container">
						<div class="d3-bar-chart"><svg width="960" height="1000"></svg></div>
					</div>
					<hr class="divider"\>
					<h3 class="top-space">Discoveries</h3>
					<ol>
						<li>In order to answer the question: is the San Francisco Fire Department fully equipped to handle the multitude and wide range of emergencies that occur in San Francisco? The theme of our midterm project is to use data from the San Francisco fire department to visualize what types of emergencies occur most frequently, and in what parts of the city.</li>
						<li>In my implementation, I demonstrate the sum of emergencies of different call types in different neighborhoods and the sum of emergencies occurring in what parts of the city.</li>
						<li>Based on my implementation, we can find out that Tenderloin, South of Market, Mission and Financial District/South Beach have the largest amount of emergencies. While Seacliff, McLaren Park and Lincoln Park have very small records. So we know that the San Francisco Fire Department should pay more attention to the areas on the top, such as adding more people and equipment or arrange staff from the areas on the bottom.</li>
						<li>What's more, among all types of call, it's obvious to see that the Potential Life-Threating has the most call and most already take up to the half among the 4 types. While the Fire only has a very small number. It means that most emergencies occurred may threaten people's life but few of them are caused by fire. So, the San Francisco Fire Department should consider preparing themselves for protecting citizens rather than preventing fire.</li>
					</ol>
					<hr class="divider"\>
					<h3 class="top-space">Inspirations</h3>
					<ol>
						<li>I think my grouping is not decent enough, specifically, it should have more details about the types. For example, I can mention more about what is behind the Potentially Life-Threating, is it car accidences or factory explosion, etc.</li>
						<li>In the first place, I didn't plan to use the zoom interactivity, because I think a tooltip is good enough. However, I realized that, for some small data, it's very hard to hover or click them as well. So I think adding a zooming functionality could help readers to select them. In this implementation, I chose to use the vertical zooming, which makes the bars wider, but I don't think it works like a charm, because some data is still very thin to see. Next time, I will try to make the bar longer/higher for a bar chart.</li>
						<li>Although hovering and licking seem compatible with this implementation, I feel that using the same tooltip to display very similar information is confusing. Next time, I prefer to use a pop-up or another chart to display similar content.</li>
						<li>Last but not least, wrangling the data or converting the original data into a more readable format, such as JavaScript object and array or a JSON object and organizing the data into a more desirable form is very helpful.</li>
					</ol>
				</div>
			</div>
		</main>
		<footer>
			<div class="footer-top">
				<div class="container">
					<div class="row">
						<div class="col-md-12 col-lg-6 footer_widget">
							<div class="inner">
								<h4>About</h4>
								<p>We are a team built by CS Students at USF. This is a website for our midterm project and you can find out the original data we are going to use for this project in our dataset.</p>
							</div>
						</div>
						<div class="col-md-12 col-lg-6 footer_widget">
							<div class="inner">
								<h4>Credits</h4>
								<ul>
									<li><a href="https://www.themeum.com" target="_blank">Theme: Flat Theme</a></li>
									<li><a href="https://getbootstrap.com/" target="_blank">Framework: Bootstrap</a></li>
									<li><a href="https://www.freepik.com" target="_blank">Images: freepik</a></li>
									<li><a href="https://unsplash.com/" target="_blank">Images: Unsplash</a></li>
									<li><a href="https://fontawesome.com" target="_blank">Icon: FontAwesome</a></li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="footer-bottom">
				<div class="container">
					<div class="row">
						<div class="col-lg-6">
							<div class="copyright-txt">
								Copyright &copy; 2020.Datalization All rights reserved.
							</div>
						</div>
					</div>
				</div>
			</div>
		</footer>
    </div>

<script>
	/*
		Declare and initialize global vars
	*/
	let dataset = d3.csv("data/bar.csv");
	let neighborhoods_set = d3.map();
	let neighborhoods = [];
	let records = [];
	let color;
	let legends = new Array();
	let legend_size = 12;

	/*
		Initialize dataset
		1. neighborhoods_set: a map to store all neighborhoods' name without duplication
		2. neighborhoods: an array to store all neighborhoods' data
		3. records: an array to store each record and its data
	*/
	dataset.then(function(data) {
		// Go throug the data and store each neighborhood and its data
		data.forEach(function(neighborhood) {
			let name = neighborhood.neighborhoods_analysis_boundaries;
			let record = {call_type_group: neighborhood.call_type_group, number_of_records: neighborhood.number_of_records};
			let total = parseInt(neighborhood.number_of_records);

			if (neighborhoods_set.has(name)) {
				neighborhoods_set.get(name).records.push(record);
				neighborhoods_set.get(name).total += total;
			} else {
				neighborhoods_set.set(name, {name: name, records: [record], total: total});
			}
		});

		// Convert the map to be a new array
		neighborhoods_set.each(function(neighborhood) {
			neighborhoods.push(neighborhood);
		});

//								console.table(neighborhoods);

		// Break down each neighborhood into smaller record and store them in a new array
		records = neighborhoods.map(function(e) {
			let neighborhood = e;
			let records = neighborhood.records;
			let start = 0;
			let number = [];

			records.forEach(function(record) {
				let key = record.call_type_group;
				let end = start + parseInt(record.number_of_records);
				const result = [];

				result[0] = parseInt(start);
				result[1] = end;
				result["data"] = neighborhood;
				result["key"] = key;

				start = end;
				number.push(result);
			});

			return number;
		});

		// Convert matrix into one-dimension array
		records = records.flat();

		// Initialize the legend's array
		records[0].forEach(function(legend) {
			legends.push(legend['key']);
		});

		// Color object for color scheme
		color = d3.scaleOrdinal()
		  .domain([records[0].keys])
		  .range(["red", "steelblue", "green", "orange"]);

		init_bar();
	});

	/*
		Create the bar chart
		1. bars: container for all the bars
		2. bar: one column of the bar
		3. block: one call type in one column of the bar
	*/
	function init_bar() {
		let svg = d3.select(".d3-bar-chart svg"),
			margin = 200,
			width = svg.attr("width") - margin,
			height = svg.attr("height") - margin;

		svg
		   .append("text")
		   .attr("transform", "translate(100,0)")
		   .attr("x", -100)
		   .attr("y", 20)
		   .text("Sum of Number of Emergencies for each Neighborhoods");

		let g = svg.append("g")
			   .attr("transform", "translate(" + 192 + "," + 140 + ")");

		// Initialize scale
		let xScale = d3.scaleLinear()
					.range([0, width])
					.domain([0, d3.max(neighborhoods.map(function(d) {
						return d.total;
					}))]);

		let	yScale = d3.scaleBand()
					.range([0, height])
					.padding(0.2)
					.domain(neighborhoods.map(function(d) { 
						return d.name;
					}));

		// Create axises
		let xAxis = g.append("g")
		 .attr("transform", "translate(0," + height + ")")
		 .call(d3.axisBottom(xScale).tickFormat(function(d){
			 return d/1000 + "K";
		 })
		 .ticks(10))
		 .attr("class", "x-axis")
		 .append("text")
		 .attr("class", "label")
		 .attr("y", 45)
		 .attr("x", width)
		 .attr("text-anchor", "end")
		 .attr("stroke", "#2d3666")
		 .text("Number of Emergencies");

		let yAxis = g.append("g")
		 .call(d3.axisLeft(yScale))
		 .attr("class", "y-axis")
		 .append("text")
		 .attr("transform", "rotate(-90)")
		 .attr("y", 60)
		 .attr("dy", "-16em")
		 .attr("text-anchor", "end")
		 .attr("stroke", "#2d3666")
		 .attr("class", "label")
		 .text("Neighborhoods - Analysis Boundaries");

		// Create the bars' container
		let bars = g.append("g")
		 .attr("class", "bars")
		 .attr("x", 0)
		 .attr("y", 200);

		// Create each bar:
		// Column is the number
		// Row is the neighborhood
		let bar = bars.selectAll(".bar")
		 .data(neighborhoods)
		 .enter()
		 .append("rect")
		 .attr("class", "bar")
		 .attr("x", 0)
		 .attr("y", function(d) {
			return yScale(d.name);
		 })
		 .attr("width", function(d) {
			return xScale(d.total);
		 })
		 .attr("height", yScale.bandwidth());

		/*
			Call type group blocks:
			Fill in with different colors by call types
		*/
		let block = bars.selectAll(".block")
		 .data(records)
		 .enter()
		 .append("rect")
//								 .attr("class", "block")
		 .attr("class", function(d) {
			 let key = d.key.toLowerCase().replace(/[&\/\\#, +()$~%.'":*?<>{}]/g, '_');
			 let data = d.data.name.toLowerCase().replace(/[&\/\\#, +()$~%.'":*?<>{}]/g, '_');
			 return "block " + key + " " + data;
		 })
		 .attr("fill", function(d) {
			return color(d.key);
		 })
		 .attr("x", function(d) {
			return xScale(d[0]);
		 })
		 .attr("y", function(d, i) {
			return yScale(d.data.name);
		 })
		 .attr("width", function(d) {
			return xScale(d[1]) - xScale(d[0]);
		 })
		 .attr("height", yScale.bandwidth());

		// Add one dot in the legend for each name.
		let legent_title = svg.append("text")
		   .attr("transform", "translate(100,0)")
		   .attr("x", 690)
		   .attr("y", 10)
		   .text("Call Type Group")
			.attr("class", "legend-title");

		let legend_rect = svg.selectAll("legend-rects")
			.data(records[0].data.records)
			.enter()
			.append("rect")
			.attr("x", 790)
			.attr("y", function(d,i){ return i * (legend_size + 5) + 22})
			.attr("width", legend_size)
			.attr("height", legend_size)
			.attr("class", "legend-rect")
			.style("fill", function(d) {
				return color(d.call_type_group);
			});

		// Add one dot in the legend for each name.
		let legend_label = svg.selectAll("legend-labels")
			.data(records[0].data.records)
			.enter()
			.append("text")
			.attr("x", 790 + legend_size * 1.5)
			.attr("y", function(d,i){ return i * (legend_size+5) + (legend_size/2) + 22})
			.text(function(d){ return d.call_type_group; })
			.attr("text-anchor", "left")
			.style("alignment-baseline", "middle")
			.attr("class", "legend-label")
			.style("fill", "#000");

		/*
			Interactivities
		*/
		var tooltip = d3.select("body").append("div").attr("class", "toolTip");

		// Mouse over to highlight the current call type among one neighborhood
		block
		.on("mouseover", function(d) {
			bars
			.selectAll("." + d.data.name.toLowerCase().replace(/[&\/\\#, +()$~%.'":*?<>{}]/g, '_'))
			.transition()
			.style("opacity", 0.5);

			d3.select(this)
			  .raise() // bring to front
			  .transition()
			  .style("opacity", 1);

			tooltip
			  .style("left", d3.event.pageX + "px")
			  .style("top", d3.event.pageY + "px")
			  .style("display", "inline-block")
			  .style("color", function() {
					return color(d.key);
				})
			  .html(function() {
				let str = "";
				str += "Neighborhood: " + d.data.name + "<br>";
				str += "Call type: " + d.key + "<br>";
				str += "# of emergencies: " + (d[1] - d[0]) + "<br>";
				str += "Ratio among this neighborhood: " + ((d[1] - d[0]) / d.data.total * 100).toFixed(1) + "%" + "<br>";

				return str;
			   });
		}).on("mouseout", function(d) {
			bars
			.selectAll(".block")
			.transition()
			.style("opacity", 1);

			bars
			.selectAll(".block")
			.transition()
			.style("opacity", 1)
			.attr("stroke-width", "0");

			tooltip.style("display", "none");
		});

		// Click to highlight the current call type among all neighborhoods
		block
		.on("click", function(d) {
			bars
			.selectAll(".block")
			.transition()
			.style("opacity", 0.5);

			bars
			.selectAll("." + d.key.toLowerCase().replace(/[&\/\\#, +()$~%.'":*?<>{}]/g, '_'))
			.transition()
			.style("opacity", 1);

			d3.select(this)
			  .raise() // bring to front
			  .transition()
			  .attr("stroke", "#f00")
			  .attr("stroke-width", "3");

			tooltip
			  .style("left", d3.event.pageX + "px")
			  .style("top", d3.event.pageY + "px")
			  .style("display", "inline-block")
			  .style("color", function() {
					return color(d.key);
				})
			  .html((function() {
				let str = "";
				let total = (function (){
					let sum = 0;
					records.forEach(function(record) {
						if (record.key == d.key) {
							sum += record[1] - record[0];
						}
					})

					return sum;
				})();

				str += "Neighborhood: " + d.data.name + "<br>";
				str += "Call type: " + d.key + "<br>";
				str += "# of emergencies: " + (d[1] - d[0]) + "<br>";
				str += "Ratio among all neighborhoods: " + ((d[1] - d[0]) / total * 100).toFixed(1) + "%" + "<br>";

				return str;
			   })());
		});

		// Zooming for the bars
		const extent = [[margin, margin], [width - margin, height - margin]];

		svg.call(d3.zoom()
		.scaleExtent([1, 4])
//								.translateExtent(extent)
		.extent([[0, 0], [width, height]])
		.on("zoom", zoomed));

		function zoomed() {
			yScale.range([0, height].map(function(d) {
				return d3.event.transform.applyY(d);
			}));

			g.lower();

			svg.selectAll(".x-axis")
			.raise();

			svg.selectAll(".y-axis")
			.call(d3.axisLeft(yScale));

			svg.selectAll(".bar")
			.attr("y", function(d) {
				return yScale(d.name);
			})
			.attr("height", yScale.bandwidth());

			svg.selectAll(".block")
			.attr("y", function(d, i) {
				return yScale(d.data.name);
			})
			.attr("height", yScale.bandwidth());
		}
	}
</script>
    <!--Required JS files-->
<script src="https://www.jq22.com/jquery/jquery-1.10.2.js"></script>
<script src="../assets/js/vendor/popper.min.js"></script>
<script src="../assets/js/vendor/bootstrap.min.js"></script>
<script src="../assets/js/vendor/owl.carousel.min.js"></script>
<script src="../assets/js/vendor/isotope.pkgd.min.js"></script>
<script src="../assets/js/vendor/jquery.barfiller.js"></script>
<script src="../assets/js/vendor/loopcounter.js"></script>
<script src="../assets/js/vendor/slicknav.min.js"></script>
<script src="../assets/js/active.js"></script>

</body>

</html>