
<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>CS360/560 Midterm: Datalization</title>

        <!-- Required CSS files -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/owl.carousel.css">
    <link rel="stylesheet" href="../assets/css/barfiller.css">
    <link rel="stylesheet" href="../assets/css/animate.css">
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/css/slicknav.css">
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="https://www.jq22.com/jquery/font-awesome.4.7.0.css">
    <script src="https://d3js.org/d3.v5.min.js"></script>
	<style>
		.chart-container {
			font-size: 24px;
			font-weight: 300;
		}
		.legend-label {
			font-size: 12px;
		}
		.legend-title {
			font-size: 12px;
			font-weight: 400;
			fill: #000;
		}
		.label {
  			font-family: "Roboto", sans-serif;
			font-size: 15px;
			font-weight: 300;
		}
		.block {
			cursor: pointer;
		}
		.toolTip {
			position: absolute;
			display: none;
			width: 220px;
			white-space: nowrap;
			height: auto;
			background-color: #ffffff;
			border: 1px solid #2d3666;
			padding: 10px;
			font-size: 13px;
			text-align: center;
			margin-top: -10px;
			transform: translate(-50%, -100%);
			/* Backward compatibility */
			-webkit-transform: translate(-50%, -100%);
			-moz-transform: translate(-50%, -100%);
			-o-transform: translate(-50%, -100%);
			-ms-transform: translate(-50%, -100%);
		}
	</style>
</head>

<body>
    <div class="preloader">
        <span class="preloader-spin"></span>
    </div>
    <div class="site">
		<header id="header">
			<div class="container">
				<div class="row">
					<div class="col-6 col-sm-3 logo-column">
						<h3><a href="/midterm-datalization/" class="logo">Datalization</a></h3>
					</div>
					<div class="col-6 col-sm-9 nav-column clearfix">
						<nav id="menu" class="d-none d-lg-block">
							<ul>
								<li><a href="/midterm-datalization/">Home</a></li>
								<li><a href="/midterm-datalization/dataset.html">Dataset</a></li>
								<li class="has-child">
									<a href="#">Prototypes</a>
									<ul class="sub-menu">
										<li><a href="/midterm-datalization/prototypes/bar-chart.html"><i class="fa fa-bar-chart"></i> Sum of Number of Records for each Neighborhooods 2010-2019</a></li>
										<li><a href="/midterm-datalization/prototypes/line-chart.html"><i class="fa fa-line-chart"></i> The Averge Response Time and Arrive Time For Emergencies 2010-2019</a></li>
										<li><a href="/midterm-datalization/prototypes/area-chart.html"><i class="fa fa-area-chart"></i> Count of Various Emergencies by Year: 2010-2019</a></li>
									</ul>
								</li>
								<li class="has-child">
									<a href="#">Implementations</a>
									<ul class="sub-menu">
										<li><a href="/midterm-datalization/implementations/bar.html"><i class="fa fa-bar-chart"></i> Sum of Number of Records for each Neighborhooods 2010-2019</a></li>
										<li><a href="/midterm-datalization/implementations/line-chart-d3.html"><i class="fa fa-line-chart"></i> The Averge Response Time and Arrive Time For Emergencies 2010-2019</a></li>
										<li><a href="/midterm-datalization/implementations/area-chart.html"><i class="fa fa-area-chart"></i> Count of Various Emergencies by Year: 2010-2019</a></li>
									</ul>
								</li>
								<li><a href="/midterm-datalization/team.html">Team</a></li>
							</ul>
						</nav>
					</div>
				</div>
			</div>
		</header>
		<main id="main">
			<div class="page-title sp" style="background-image: url(../assets/img/home-banner.jpg)">
				<div class="container text-center">
					<h2>D3 Implementation</h2>
					<p>Sum of Number of Emergencies for each Neighborhooods</p>
				</div>
			</div>
			<div class="about-area sp">
				<div class="container content-main">
					<h2>Sum of Number of Emergencies for each Neighborhooods</h2>
					<hr class="divider"\>
					<div class="chart-container">
						<div class="d3-bar-chart"><svg width="960" height="1000"></svg></div>
					</div>
				</div>
			</div>
		</main>
		<footer>
			<div class="footer-top">
				<div class="container">
					<div class="row">
						<div class="col-md-12 col-lg-6 footer_widget">
							<div class="inner">
								<h4>About</h4>
								<p>We are a team built by CS Students at USF. This is a website for our midterm project and you can find out the original data we are going to use for this project in our dataset.</p>
							</div>
						</div>
						<div class="col-md-12 col-lg-6 footer_widget">
							<div class="inner">
								<h4>Credits</h4>
								<ul>
									<li><a href="https://www.themeum.com" target="_blank">Theme: Flat Theme</a></li>
									<li><a href="https://getbootstrap.com/" target="_blank">Framework: Bootstrap</a></li>
									<li><a href="https://www.freepik.com" target="_blank">Images: freepik</a></li>
									<li><a href="https://unsplash.com/" target="_blank">Images: Unsplash</a></li>
									<li><a href="https://fontawesome.com" target="_blank">Icon: FontAwesome</a></li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="footer-bottom">
				<div class="container">
					<div class="row">
						<div class="col-lg-6">
							<div class="copyright-txt">
								Copyright &copy; 2020.Datalization All rights reserved.
							</div>
						</div>
					</div>
				</div>
			</div>
		</footer>
    </div>

<script>
	/*
		Declare and initialize global vars
	*/
	let dataset = d3.csv("data/bar.csv");
	let neighborhooods_set = d3.map();
	let neighborhooods = [];
	let records = [];
	let color;
	let legends = new Array();
	let legend_size = 12;

	/*
		Initialize dataset
		1. neighborhooods_set: a map to store all neighborhooods' name without duplication
		2. neighborhooods: an array to store all neighborhooods' data
		3. records: an array to store each record and its data
	*/
	dataset.then(function(data) {
		// Go throug the data and store each neighborhoood and its data
		data.forEach(function(neighborhoood) {
			let name = neighborhoood.neighborhooods_analysis_boundaries;
			let record = {call_type_group: neighborhoood.call_type_group, number_of_records: neighborhoood.number_of_records};
			let total = parseInt(neighborhoood.number_of_records);

			if (neighborhooods_set.has(name)) {
				neighborhooods_set.get(name).records.push(record);
				neighborhooods_set.get(name).total += total;
			} else {
				neighborhooods_set.set(name, {name: name, records: [record], total: total});
			}
		});

		// Convert the map to be a new array
		neighborhooods_set.each(function(neighborhoood) {
			neighborhooods.push(neighborhoood);
		});

//								console.table(neighborhooods);

		// Break down each neighborhoood into smaller record and store them in a new array
		records = neighborhooods.map(function(e) {
			let neighborhoood = e;
			let records = neighborhoood.records;
			let start = 0;
			let number = [];

			records.forEach(function(record) {
				let key = record.call_type_group;
				let end = start + parseInt(record.number_of_records);
				const result = [];

				result[0] = parseInt(start);
				result[1] = end;
				result["data"] = neighborhoood;
				result["key"] = key;

				start = end;
				number.push(result);
			});

			return number;
		});

		// Convert matrix into one-dimension array
		records = records.flat();

		// Initialize the legend's array
		records[0].forEach(function(legend) {
			legends.push(legend['key']);
		});

		// Color object for color scheme
		color = d3.scaleOrdinal()
		  .domain([records[0].keys])
		  .range(["#E15759", "#4E79A7", "#59A14F", "#F28E2B"]);

		init_bar();
	});

	/*
		Create the bar chart
		1. bars: container for all the bars
		2. bar: one column of the bar
		3. block: one call type in one column of the bar
	*/
	function init_bar() {
		let svg = d3.select(".d3-bar-chart svg"),
			margin = 200,
			width = svg.attr("width") - margin,
			height = svg.attr("height") - margin;

		svg
		   .append("text")
		   .attr("transform", "translate(100,0)")
		   .attr("x", -100)
		   .attr("y", 20)
		   .text("Sum of Number of Emergencies for each Neighborhooods");

		let g = svg.append("g")
			   .attr("transform", "translate(" + 192 + "," + 140 + ")");

		// Initialize scale
		let xScale = d3.scaleLinear()
					.range([0, width])
					.domain([0, d3.max(neighborhooods.map(function(d) {
						return d.total;
					}))]);

		let	yScale = d3.scaleBand()
					.range([0, height])
					.padding(0.2)
					.domain(neighborhooods.map(function(d) { 
						return d.name;
					}));

		// Create axises
		let xAxis = g.append("g")
		 .attr("transform", "translate(0," + height + ")")
		 .call(d3.axisBottom(xScale).tickFormat(function(d){
			 return d/1000 + "K";
		 })
		 .ticks(10))
		 .attr("class", "x-axis")
		 .append("text")
		 .attr("class", "label")
		 .attr("y", 45)
		 .attr("x", width)
		 .attr("text-anchor", "end")
		 .attr("stroke", "#2d3666")
		 .text("Number of Emergencies");

		let yAxis = g.append("g")
		 .call(d3.axisLeft(yScale))
		 .attr("class", "y-axis")
		 .append("text")
		 .attr("transform", "rotate(-90)")
		 .attr("y", 60)
		 .attr("dy", "-16em")
		 .attr("text-anchor", "end")
		 .attr("stroke", "#2d3666")
		 .attr("class", "label")
		 .text("Neighborhooods - Analysis Boundaries");

		// Create the bars' container
		let bars = g.append("g")
		 .attr("class", "bars")
		 .attr("x", 0)
		 .attr("y", 200);

		// Create each bar:
		// Column is the number
		// Row is the neighborhoood
		let bar = bars.selectAll(".bar")
		 .data(neighborhooods)
		 .enter()
		 .append("rect")
		 .attr("class", "bar")
		 .attr("x", 0)
		 .attr("y", function(d) {
			return yScale(d.name);
		 })
		 .attr("width", function(d) {
			return xScale(d.total);
		 })
		 .attr("height", yScale.bandwidth());

		/*
			Call type group blocks:
			Fill in with different colors by call types
		*/
		let block = bars.selectAll(".block")
		 .data(records)
		 .enter()
		 .append("rect")
//								 .attr("class", "block")
		 .attr("class", function(d) {
			 let key = d.key.toLowerCase().replace(/[&\/\\#, +()$~%.'":*?<>{}]/g, '_');
			 let data = d.data.name.toLowerCase().replace(/[&\/\\#, +()$~%.'":*?<>{}]/g, '_');
			 return "block " + key + " " + data;
		 })
		 .attr("fill", function(d) {
			return color(d.key);
		 })
		 .attr("x", function(d) {
			return xScale(d[0]);
		 })
		 .attr("y", function(d, i) {
			return yScale(d.data.name);
		 })
		 .attr("width", function(d) {
			return xScale(d[1]) - xScale(d[0]);
		 })
		 .attr("height", yScale.bandwidth());

		// Add one dot in the legend for each name.
		let legent_title = svg.append("text")
		   .attr("transform", "translate(100,0)")
		   .attr("x", 690)
		   .attr("y", 10)
		   .text("Call Type Group")
			.attr("class", "legend-title");

		let legend_rect = svg.selectAll("legend-rects")
			.data(records[0].data.records)
			.enter()
			.append("rect")
			.attr("x", 790)
			.attr("y", function(d,i){ return i * (legend_size + 5) + 22})
			.attr("width", legend_size)
			.attr("height", legend_size)
			.attr("class", "legend-rect")
			.style("fill", function(d) {
				return color(d.call_type_group);
			});

		// Add one dot in the legend for each name.
		let legend_label = svg.selectAll("legend-labels")
			.data(records[0].data.records)
			.enter()
			.append("text")
			.attr("x", 790 + legend_size * 1.5)
			.attr("y", function(d,i){ return i * (legend_size+5) + (legend_size/2) + 22})
			.text(function(d){ return d.call_type_group; })
			.attr("text-anchor", "left")
			.style("alignment-baseline", "middle")
			.attr("class", "legend-label")
			.style("fill", "#000");

		/*
			Interactivities
		*/
		var tooltip = d3.select("body").append("div").attr("class", "toolTip");

		// Mouse over to highlight the current call type amount one neighborhoood
		block
		.on("mouseover", function(d) {
			bars
			.selectAll("." + d.data.name.toLowerCase().replace(/[&\/\\#, +()$~%.'":*?<>{}]/g, '_'))
			.transition()
			.style("opacity", 0.5);

			d3.select(this)
			  .raise() // bring to front
			  .transition()
			  .style("opacity", 1);

			tooltip
			  .style("left", d3.event.pageX + "px")
			  .style("top", d3.event.pageY + "px")
			  .style("display", "inline-block")
			  .style("color", function() {
					return color(d.key);
				})
			  .html(function() {
				let str = "";
				str += d.data.name + "<br>";
				str += d.key + "<br>";
				str += (d[1] - d[0]) + "<br>";
				str += "% amount this neighborhoood: <br>";
				str += ((d[1] - d[0]) / d.data.total * 100).toFixed(1) + "%" + "<br>";

				return str;
			   });
		}).on("mouseout", function(d) {
			bars
			.selectAll(".block")
			.transition()
			.style("opacity", 1);

			bars
			.selectAll(".block")
			.transition()
			.style("opacity", 1)
			.attr("stroke-width", "0");

			tooltip.style("display", "none");
		});

		// Click to highlight the current call type amount all neighborhooods
		block
		.on("click", function(d) {
			bars
			.selectAll(".block")
			.transition()
			.style("opacity", 0.5);

			bars
			.selectAll("." + d.key.toLowerCase().replace(/[&\/\\#, +()$~%.'":*?<>{}]/g, '_'))
			.transition()
			.style("opacity", 1);

			d3.select(this)
			  .raise() // bring to front
			  .transition()
			  .attr("stroke", "#f00")
			  .attr("stroke-width", "3");

			tooltip
			  .style("left", d3.event.pageX + "px")
			  .style("top", d3.event.pageY + "px")
			  .style("display", "inline-block")
			  .style("color", function() {
					return color(d.key);
				})
			  .html((function() {
				let str = "";
				let total = (function (){
					let sum = 0;
					records.forEach(function(record) {
						if (record.key == d.key) {
							sum += record[1] - record[0];
						}
					})

					return sum;
				})();

				str += d.data.name + "<br>";
				str += d.key + "<br>";
				str += d[1] - d[0] + "<br>";
				str += "% amount all neighborhooods: <br>";
				str += ((d[1] - d[0]) / total * 100).toFixed(1) + "%" + "<br>";

				return str;
			   })());
		});

		// Zooming for the bars
		const extent = [[margin, margin], [width - margin, height - margin]];

		svg.call(d3.zoom()
		.scaleExtent([1, 4])
//								.translateExtent(extent)
		.extent([[0, 0], [width, height]])
		.on("zoom", zoomed));

		function zoomed() {
			yScale.range([0, height].map(function(d) {
				return d3.event.transform.applyY(d);
			}));

			g.lower();

			svg.selectAll(".x-axis")
			.raise();

			svg.selectAll(".y-axis")
			.call(d3.axisLeft(yScale));

			svg.selectAll(".bar")
			.attr("y", function(d) {
				return yScale(d.name);
			})
			.attr("height", yScale.bandwidth());

			svg.selectAll(".block")
			.attr("y", function(d, i) {
				return yScale(d.data.name);
			})
			.attr("height", yScale.bandwidth());
		}
	}
</script>
    <!--Required JS files-->
<script src="https://www.jq22.com/jquery/jquery-1.10.2.js"></script>
<script src="../assets/js/vendor/popper.min.js"></script>
<script src="../assets/js/vendor/bootstrap.min.js"></script>
<script src="../assets/js/vendor/owl.carousel.min.js"></script>
<script src="../assets/js/vendor/isotope.pkgd.min.js"></script>
<script src="../assets/js/vendor/jquery.barfiller.js"></script>
<script src="../assets/js/vendor/loopcounter.js"></script>
<script src="../assets/js/vendor/slicknav.min.js"></script>
<script src="../assets/js/active.js"></script>

</body>

</html>